#!/usr/bin/env bash
#shellcheck disable=SC2089
#
# Make website from .md files
#
# Author: zenobit <zen@duck.com>
# Date: February 14, 2026
# License: MIT
#

count=$(find ./ -name '*.md' | wc -l)

# Functions for colored bordered messages (gum) or ANSI colored messages
if command -v gum -v >/dev/null; then
	_r() {
		gum style --border rounded --border-foreground "#e50203" --padding "0 1" "${@}"
	}

	_re() {
		gum style --border rounded --border-foreground "#e50203" --padding "0 1" "${@}"
		exit 1
	}

	_g() {
		gum style --border rounded --border-foreground "#14a113" --padding "0 1" "$@"
	}

	_b() {
		gum style --border rounded --border-foreground "#004EFB" --padding "0 1" "$@"
	}

	_y() {
		gum style --border rounded --border-foreground "#fdde13" --padding "0 1" "$@"
	}

	_header() {
		local text green red yellow
		text="${1}"
		red=$(gum style --border rounded --border-foreground "#e50203" --padding "0 1" "$text")
		yellow=$(gum style --border rounded --border-foreground "#fdde13" --padding "0 1" "$red")
		green=$(gum style --border rounded --border-foreground "#14a113" --padding "0 1" "$yellow")
		echo "$green"
	}

	_footer() {
		local text green red yellow
		text="${1}"
		green=$(gum style --border rounded --border-foreground "#14a113" --padding "0 1" "$text")
		yellow=$(gum style --border rounded --border-foreground "#fdde13" --padding "0 1" "$green")
		red=$(gum style --border rounded --border-foreground "#e50203" --padding "0 1" "$yellow")
		echo "$red"
	}
else
	RED='\033[0;31m'
	GREEN='\033[0;32m'
	YELLOW='\033[1;33m'
	BLUE='\033[0;34m'
	#CYAN='\033[0;36m'
	NC='\033[0m'

	_g() {
		echo -e "${GREEN}${1}${NC}"
	}

	_r() {
		echo -e "${RED}${1}${NC}"
	}

	_re() {
		echo -e "${RED}${1}${NC}" >&2
		exit 1
	}

	_b() {
		echo -e "${BLUE}${1}${NC}"
	}

	_y() {
		echo -e "${YELLOW}${1}${NC}"
	}

	_header() {
		echo -e "\n${RED}${1}${NC}\n"
	}

	_footer() {
		echo -e "\n${RED}${1}${NC}\n"
	}
fi
export -f _r _re _g _b _y

# Target: build
target_build() { ## Builds the website needs: title argument!
	title="$1"
	if [ -z "$title" ]; then
		_re "No website title provided!"
	fi
	_g "Creating $title"
#
#./make-html-grub
#./make-html-hires
#./make-html-lowres
#./make-html-logos
#./make-html-index-rest
	if [ "$count" = 1 ]; then
		for file in *.md; do
			[ -f "$file" ] || continue
			echo "Processing: $file → index.html"
			pandoc "$file" -f gfm -s \
			 --css=style.css \
			 --include-before-body=_site/toggle.html \
			 --metadata title="$title" \
			 -o _site/index.html
		done
	elif [ "$count" -gt 1 ]; then
		for file in *.md; do
			[ -f "$file" ] || continue
			output="_site/${file%.md}.html"
			echo "Processing: $file → $output"
			if [ "$file" = README.md ]; then
				pandoc "$file" -f gfm \
				 --css=style.css \
				 --include-before-body=_site/toggle.html \
				 --metadata title="$title" \
				 -o _site/index.html
			else
				pandoc "$file" -f gfm --css=style.css \
				 --include-before-body=_site/toggle.html \
				 --metadata title="${file%.md}" \
				 -o "$output"
			fi
		done
	else
		echo "ERROR: Not .md files found!"
		exit 1
	fi
	_g "Finished"
}

# Target: help
target_help() { ## Show this help message
	_b 'OSOWOSO Website Build System'
	echo ""
	echo "Usage: $0 [target]"
	echo ""
	echo "Available targets:"
	echo ""
	awk 'BEGIN {FS = "## "}
         /^target_[a-zA-Z_-]+\(\).*## / {
             sub(/target_/, "", $1)
             sub(/\(\) \{/, "", $1)
             gsub(/^[ \t]+/, "", $1)
             printf "  \033[36m%-15s\033[0m %s\n", $1, $2
         }' "$0" | sort
	echo ""
}

# Target: serve
target_serve() { ## Serve site locally out of _site folder
	if [ ! -f _site/index.html ]; then
		_r "Site not built!"
		gum confirm 'Build first?' && target_build "$@" || _re "Exiting"
	fi

	_g 'Press Ctrl+C to stop'
	python3 -m http.server -d _site 8000
}

# Main script logic
main() {
	local target="${1:-help}"

	# Remove "target_" prefix if user included it
	target="${target#target_}"

	# Convert hyphens to underscores for function names
	local func_name="target_${target//-/_}"

	# Check if function exists
	if declare -f "$func_name" > /dev/null; then
		shift
		"$func_name" "$@"
	else
		#shellcheck disable=SC2016,2086
		_re 'Unknown target: $target. Run '$0 help' for available targets.'
	fi
}

# Run main with all arguments
main "$@"
